# エージェント

重い作業を行い、コンテキストを保存するために簡潔な要約を返す専門エージェント。

## コア哲学

> 「サブエージェントを擬人化しないでください。プロンプトを整理し、コンテキストを省略するために使用してください。サブエージェントは、多くの作業を行いながら、メインの会話スレッドに少量の情報だけを返す場合に最も効果的です。」
>
> – Adam Wolff, Anthropic

## 利用可能なエージェント

### code-analyzer
- **目的**: メインコンテキストを汚染せずに複数ファイルにまたがるバグを追跡
- **パターン**: 多数のファイルを検索 → コードを分析 → バグレポートを返す
- **使用場面**: ロジックフローのトレース、バグ発見、変更の検証が必要な場合
- **返却**: 重要な発見のみを含む簡潔なバグレポート

### file-analyzer
- **目的**: 冗長なファイル（ログ、出力、設定）を読み取り要約
- **パターン**: ファイルを読み取り → インサイトを抽出 → 要約を返す
- **使用場面**: ログファイルの理解や冗長な出力の分析が必要な場合
- **返却**: 主要な発見と実行可能なインサイト（80-90%のサイズ削減）

### test-runner
- **目的**: メインスレッドに出力をダンプせずにテストを実行
- **パターン**: テスト実行 → ログにキャプチャ → 結果を分析 → 要約を返す
- **使用場面**: テストの実行と失敗の理解が必要な場合
- **返却**: 失敗分析を含むテスト結果の要約

### parallel-worker
- **目的**: Issue の複数の並列作業ストリームを調整
- **パターン**: 分析を読み取り → サブエージェントを生成 → 結果を統合 → 要約を返す
- **使用場面**: Worktree で並列作業ストリームを実行する場合
- **返却**: すべての並列作業の統合ステータス

## なぜエージェントか？

エージェントは、メインの会話を情報過多から守る**コンテキストファイアウォール**です：

```
エージェントなし:
メインスレッドが10ファイル読み取り → コンテキスト爆発 → 一貫性を失う

エージェントあり:
エージェントが10ファイル読み取り → メインスレッドは1つの要約を受け取り → コンテキスト保存
```

## エージェントがコンテキストを保存する方法

1. **重い作業** - エージェントが面倒な作業を行う（ファイル読み取り、テスト実行、機能実装）
2. **コンテキスト分離** - 実装の詳細はエージェント内に留まり、メインスレッドには入らない
3. **簡潔な返却** - 本質的な情報のみがメインの会話に戻る
4. **並列実行** - 複数のエージェントがコンテキスト衝突なしに同時に作業可能

## 使用例

```bash
# バグのコード分析
タスク: 「コードベースでメモリリークを検索」
エージェント: code-analyzer
返却: 「3つの潜在的なリークを発見: [簡潔なリスト]」
メインスレッドは見ない: 調査された数百のファイル

# テスト実行
タスク: 「認証テストを実行」
エージェント: test-runner
返却: 「2/10テストが失敗: [失敗の要約]」
メインスレッドは見ない: 冗長なテスト出力とログ

# 並列実装
タスク: 「並列ストリームでIssue #1234を実装」
エージェント: parallel-worker
返却: 「4/4ストリーム完了、15ファイル変更」
メインスレッドは見ない: 個別の実装詳細
```

## 新しいエージェントの作成

新しいエージェントは以下の原則に従う必要があります：

1. **単一目的** - 各エージェントには1つの明確な仕事がある
2. **コンテキスト削減** - 処理したものの10-20%を返す
3. **ロールプレイなし** - エージェントは「エキスパート」ではなく、タスク実行者
4. **明確なパターン** - 入力 → 処理 → 出力のパターンを定義
5. **エラー処理** - 失敗を適切に処理し、明確に報告

## 避けるべきアンチパターン

- **「スペシャリスト」エージェントの作成**（database-expert、api-expert）
  エージェントは異なる知識を持っていない - すべて同じモデル

- **冗長な出力を返す**
  コンテキスト保存の目的を無効にする

- **エージェント間で通信させる**
  代わりにコーディネーターエージェント（parallel-workerなど）を使用

- **単純なタスクにエージェントを使用**
  コンテキスト削減が価値ある場合にのみエージェントを使用

## PMシステムとの統合

エージェントはPMコマンドシステムとシームレスに統合：

- `/pm-issue-analyze` → 作業ストリームを特定
- `/pm-issue-start` → parallel-workerエージェントを生成
- parallel-worker → 複数のサブエージェントを生成
- サブエージェント → Worktreeで並列に作業
- 結果 → メインスレッドに統合

これにより、各レベルでコンテキストを保存しながら並列性を最大化する階層が作成されます。

## OpenCode設定

エージェントは `.opencode/agents/` で定義され、`opencode.json` で設定されます：

```
.opencode/
├── agents/
│   ├── code-analyzer.md
│   ├── file-analyzer.md
│   ├── test-runner.md
│   └── parallel-worker.md
└── commands/
    └── pm-*.md
```

データファイルは `.ccpm/` に保存されます：

```
.ccpm/
├── prds/          # プロダクト要件ドキュメント
├── epics/         # エピックとタスクファイル
├── context/       # プロジェクトコンテキスト
└── rules/         # 運用ルール
```
